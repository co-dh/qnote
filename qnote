#!/usr/bin/expect -f

# Markdown are placed inside Q's block comment.
# q code blocks inside Markdown will be executed.
# When exits from block comment, output ~~~q, and output ~~~ before enter block comment or exit file.

spawn q 
expect "q)"

set fp [open [lindex $argv 0] r]
# TODO: multiple line function
puts "~~~q"
set state code

foreach line [split [read $fp] "\n"] { 
    switch -regexp $line {
        {^~~~[ ]*$}  -
        {^/[ ]*$}    { puts "~~~" ; set state comment }
        {^~~~q[ ]*$} -
        {^\\[ ]*$}   { puts "~~~q"; set state code    }
        default      {
            if {$state eq "code" } {
                send -- "[string trim $line]\r"
                expect "\nq)"
            } else { puts $line }
        } 
    }
} 

close $fp
exit
